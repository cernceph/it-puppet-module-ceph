FastCgiExternalServer /var/www/s3gw.fcgi -socket /var/run/ceph/radosgw.<%= @hostname %>

#LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" proxy_combined
LogFormat "{ \"@timestamp\": \"%{%Y-%m-%dT%H:%M:%S%z}t\", \"@fields\": { \"client\": \"%a\", \"duration_usec\": %D, \"status\": %>s, \"path\": \"%U\", \"query_string\": \"%q\", \"method\": \"%m\", \"referrer\": \"%{Referer}i\", \"user_agent\": \"%{User-Agent}i\", \"remote_user\": \"%u\", \"byte_total\": %O, \"bytes_non_header\": %B, \"host\": \"%{Host}i\", \"rgw_access_key\": \"%{Authorization}i\", \"forwarded_for\": \"%{X-Forwarded-For}i\" } }" proxy_combined
LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" proxy_debug

ExtendedStatus on
<Location /mod_status>
  SetHandler server-status
</Location>

<VirtualHost *:80>
  ServerName <%= @fqdn %>
  ServerAdmin <%= @admin_email %>
  DocumentRoot /var/www/

  RewriteEngine On
  RewriteRule ^/([a-zA-Z0-9-_.]*)([/]?.*) /s3gw.fcgi?page=$1&params=$2&%{QUERY_STRING} [E=HTTP_AUTHORIZATION:%{HTTP:Authorization},L]

  <IfModule mod_fastcgi.c>
    <Directory /var/www/>
      Options +ExecCGI
      AllowOverride All
      SetHandler fastcgi-script
      Order allow,deny
      Allow from all
      AuthBasicAuthoritative Off
    </Directory>
  </IfModule>

  AllowEncodedSlashes On

  ErrorLog /var/log/httpd/error.log
  CustomLog /var/log/httpd/rgw-access.log proxy_combined
  ServerSignature Off
</VirtualHost>

TraceEnable Off
